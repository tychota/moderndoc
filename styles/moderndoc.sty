% =============================================================================
% MODERNDOC.STY — Modern Document Styling for LuaLaTeX
% =============================================================================
% A comprehensive style package for academic documents with:
%   • IBM Plex font family (with Japanese support)
%   • Microtype for professional typography
%   • Multilingual support (English, French, Japanese)
%   • PDF 2.0 with PDF/A-4 archival compliance (ISO 19005-4:2020)
%   • Modern bibliography with biblatex
%   • Code highlighting with minted
%   • Quote boxes with tcolorbox
%   • Modern tables with tabularray
%   • Publication-quality typographic controls
%
% Usage: \usepackage{moderndoc}
% Options: article, paper, thesis, book, report, letter
% Compile with: lualatex --shell-escape document.tex
%
% PDF/A-4 Support:
%   All templates use \DocumentMetadata{pdfstandard=a-4} for PDF/A-4 compliance.
%   This ensures long-term archival compatibility while maintaining PDF 2.0 features.
%   PDF/A-4 automatically handles: XMP metadata, sRGB output intent, font embedding.
% =============================================================================

\NeedsTeXFormat{LaTeX2e}[2022/06/01]
\ProvidesPackage{moderndoc}[2025/12/22 v2.0 Modern Document Styling]

% =============================================================================
% WARNING FILTERS (must be loaded early)
% =============================================================================
% Using silence package to filter warnings that are informational and harmless:
% 1. @footnotemark warning: comes from latex-lab tagging modifying footnotes
%    for PDF accessibility. Expected when using \DocumentMetadata.
% 2. luatexja microtype warning: informational about patch compatibility
% 3. Kanji font shape warnings: Japanese fonts lack italic/slanted/sc variants
%    (this is standard for CJK typography)
\RequirePackage{silence}
\WarningFilter{latex}{Command \string\@footnotemark\space has changed}
\WarningFilter{luatexja}{LuaTeX-ja's patch against the microtype package}
\WarningFilter{latexfont}{Font shape}
\WarningFilter{latexfont}{Some font shapes}

% =============================================================================
% PACKAGE OPTIONS
% =============================================================================
\RequirePackage{kvoptions}
\SetupKeyvalOptions{
  family=mdoc,
  prefix=mdoc@
}

% Document type options (mutually exclusive)
\DeclareBoolOption[false]{article}
\DeclareBoolOption[false]{paper}
\DeclareBoolOption[false]{thesis}
\DeclareBoolOption[false]{book}
\DeclareBoolOption[false]{report}
\DeclareBoolOption[false]{letter}

% Feature options
\DeclareBoolOption[false]{draft}       % Draft mode (watermark, line numbers)
\DeclareBoolOption[true]{minted}       % Code highlighting
\DeclareBoolOption[true]{biblatex}     % Bibliography
\DeclareBoolOption[true]{hyperlinks}   % Hyperref setup

% Output mode options
\DeclareBoolOption[false]{print}       % Print-optimized (no colored links)
\DeclareBoolOption[false]{pdfa}        % PDF/A mode (use with pdfstandard in DocumentMetadata)
\DeclareBoolOption[false]{accessible}  % Tagged PDF for accessibility (via DocumentMetadata)

% Feature toggles
\DeclareBoolOption[false]{makeindex}   % Enable index generation

% String options
\DeclareStringOption[numeric]{citestyle}
\DeclareStringOption[en-US]{language}
\DeclareStringOption[plex]{font}       % Font family: plex, stix, palatino

\ProcessKeyvalOptions*

% =============================================================================
% CORE PACKAGES
% =============================================================================
% Font selection for LuaLaTeX
\RequirePackage{fontspec}

% Microtypography (protrusion, expansion, tracking)
\RequirePackage[
  protrusion = true,
  expansion  = true,
  tracking   = true,
  babel      = true,
  final
]{microtype}

% Language support
\RequirePackage{polyglossia}
\setdefaultlanguage[variant=american]{english}
\setotherlanguage{french}
\setotherlanguage[spelling=new]{german}

% Utilities
\RequirePackage{etoolbox}

% Japanese support
\RequirePackage{luatexja}
\RequirePackage[match]{luatexja-fontspec}

% =============================================================================
% ADDITIONAL PUBLICATION-QUALITY PACKAGES
% =============================================================================
% Float barriers
\RequirePackage{placeins}

% Enhanced mathematics
\RequirePackage{mathtools}

% Require minimum space before environment
\RequirePackage{needspace}

% Margin notes independent of floats
\RequirePackage{marginnote}

% Enhanced appendix support (not for letters)
\ifmdoc@letter\else
  \RequirePackage{appendix}
\fi

% Index generation (conditional)
\ifmdoc@makeindex
  \RequirePackage[intoc]{imakeidx}
  \makeindex[columns=2]
\fi

% =============================================================================
% FONT CONFIGURATION
% =============================================================================

% --- OPTION: IBM PLEX (Default) ---
\ifdefstring{\mdoc@font}{plex}{
  % IBM Plex: Designed for "mankind + machine" — engineered warmth
  % Characteristics: Square-ish curves, rational geometry, complete ecosystem

  % --- BODY: IBM Plex Serif ---
  % Note: IBM Plex Serif lacks native small caps, so we use FakeSmallCaps
  % Note: Also lacks slanted variant, so we map slanted to italic
  \setmainfont{IBM Plex Serif}[
    Ligatures      = {TeX, Common},
    Numbers        = {OldStyle, Proportional},
    BoldFont       = {IBM Plex Serif Bold},
    ItalicFont     = {IBM Plex Serif Italic},
    BoldItalicFont = {IBM Plex Serif Bold Italic},
    SlantedFont    = {IBM Plex Serif Italic},      % Map slanted to italic
    BoldSlantedFont = {IBM Plex Serif Bold Italic}, % Map bold slanted to bold italic
    SmallCapsFont  = {IBM Plex Serif},  % Use same font for SC
    SmallCapsFeatures = {FakeSmallCaps, LetterSpace=5},
  ]

  % --- HEADINGS: IBM Plex Sans ---
  % Note: IBM Plex Sans also lacks native small caps
  \setsansfont{IBM Plex Sans}[
    Scale          = MatchLowercase,
    Ligatures      = {TeX, Common},
    Numbers        = {Lining, Proportional},
    BoldFont       = {IBM Plex Sans Bold},
    ItalicFont     = {IBM Plex Sans Italic},
    BoldItalicFont = {IBM Plex Sans Bold Italic},
    SmallCapsFont  = {IBM Plex Sans},
    SmallCapsFeatures = {FakeSmallCaps, LetterSpace=5},
  ]

  % Heading font family
  \newfontfamily\headingfont{IBM Plex Sans}[
    Scale          = MatchLowercase,
    Ligatures      = {TeX, Common},
    BoldFont       = {IBM Plex Sans Bold},
    SmallCapsFont  = {IBM Plex Sans},
    SmallCapsFeatures = {FakeSmallCaps, LetterSpace=5},
  ]

  % --- QUOTES: IBM Plex Serif Italic ---
  \newfontfamily\quotefont{IBM Plex Serif}[
    Ligatures      = {TeX, Common},
    Numbers        = {OldStyle, Proportional},
    ItalicFont     = {IBM Plex Serif Italic},
  ]

  % --- CODE: IBM Plex Mono ---
  \setmonofont{IBM Plex Mono}[
    Scale          = 0.85,
    BoldFont       = {IBM Plex Mono Bold},
    ItalicFont     = {IBM Plex Mono Italic},
    BoldItalicFont = {IBM Plex Mono Bold Italic},
  ]
}{}

% --- OPTION: STIX TWO ---
\ifdefstring{\mdoc@font}{stix}{
  \setmainfont{STIX Two Text}[
    Ligatures = {TeX, Common},
    Numbers   = {OldStyle, Proportional},
  ]
  \setsansfont{IBM Plex Sans}[ % Keep Plex Sans for headings as it pairs well
    Scale     = MatchLowercase,
    BoldFont  = {IBM Plex Sans Bold},
  ]
  \newfontfamily\headingfont{IBM Plex Sans}[
    Scale     = MatchLowercase,
    BoldFont  = {IBM Plex Sans Bold},
  ]
  \newfontfamily\quotefont{STIX Two Text}[
    Ligatures  = {TeX, Common},
    Numbers    = {OldStyle, Proportional},
    ItalicFont = {STIX Two Text Italic},
  ]
  \setmonofont{IBM Plex Mono}[Scale=0.85]
}{}

% --- OPTION: PALATINO (TeX Gyre) ---
\ifdefstring{\mdoc@font}{palatino}{
  \setmainfont{TeX Gyre Pagella}[
    Ligatures = {TeX, Common},
    Numbers   = {OldStyle, Proportional},
  ]
  \setsansfont{TeX Gyre Heros}[
    Scale     = MatchLowercase,
    Ligatures = {TeX, Common},
  ]
  \newfontfamily\headingfont{TeX Gyre Heros}[
    Scale     = MatchLowercase,
    BoldFont  = {TeX Gyre Heros Bold},
  ]
  \newfontfamily\quotefont{TeX Gyre Pagella}[
    Ligatures  = {TeX, Common},
    Numbers    = {OldStyle, Proportional},
    ItalicFont = {TeX Gyre Pagella Italic},
  ]
  \setmonofont{TeX Gyre Cursor}[Scale=MatchLowercase]
}{}

% --- JAPANESE: IBM Plex Sans JP / Noto fallback ---
\IfFontExistsTF{IBM Plex Sans JP}{
  \setmainjfont{IBM Plex Sans JP}[
    Scale    = 0.95,
    BoldFont = {IBM Plex Sans JP Bold},
  ]
  \setsansjfont{IBM Plex Sans JP}[
    Scale    = 0.95,
    BoldFont = {IBM Plex Sans JP Bold},
  ]
}{
  % Fallback to Noto Sans JP if IBM Plex Sans JP not available
  \IfFontExistsTF{Noto Sans JP}{
    \setmainjfont{Noto Sans JP}[Scale = 0.95]
    \setsansjfont{Noto Sans JP}[Scale = 0.95]
  }{}
}

% =============================================================================
% MICROTYPE TRACKING FOR SMALL CAPS
% =============================================================================
\SetTracking{encoding = *, shape = sc}{50}

% =============================================================================
% WIDOW/ORPHAN CONTROL AND TYPOGRAPHIC QUALITY
% =============================================================================
% Strict widow/orphan control
\widowpenalty=10000
\clubpenalty=10000
\displaywidowpenalty=10000
\predisplaypenalty=10000

% Discourage page break within paragraph
\interlinepenalty=1000

% Allow extra stretch to avoid overfull boxes
\emergencystretch=1em

% =============================================================================
% FLOAT PLACEMENT OPTIMIZATION
% =============================================================================
\renewcommand{\topfraction}{0.85}
\renewcommand{\bottomfraction}{0.70}
\renewcommand{\textfraction}{0.15}
\renewcommand{\floatpagefraction}{0.75}

\setcounter{topnumber}{3}
\setcounter{bottomnumber}{2}
\setcounter{totalnumber}{5}

% =============================================================================
% DRAFT MODE
% =============================================================================
\ifmdoc@draft
  \RequirePackage{draftwatermark}
  \SetWatermarkText{DRAFT}
  \SetWatermarkScale{1}
  \SetWatermarkColor[gray]{0.9}

  \RequirePackage{lineno}
  \linenumbers
\fi

% =============================================================================
% PAGE GEOMETRY (conditional on document type)
% =============================================================================
\RequirePackage{geometry}

\ifmdoc@article
  \geometry{
    a4paper,
    left      = 25mm,
    right     = 25mm,
    top       = 30mm,
    bottom    = 30mm,
    headheight   = 15pt,  % Increased for scrlayer-scrpage compatibility
    headsep      = 18pt,
    footskip     = 22pt,
    marginparsep = 5mm,
    marginparwidth = 18mm,
  }
  \linespread{1.08}
\fi

\ifmdoc@paper
  \geometry{
    a4paper,
    left      = 18mm,
    right     = 18mm,
    top       = 22mm,
    bottom    = 25mm,
    columnsep = 6mm,
    headheight   = 15pt,  % Increased for scrlayer-scrpage compatibility
    headsep      = 12pt,
    footskip     = 18pt,
  }
  \linespread{1.04}
  % Smaller fonts for two-column papers
  \AtBeginDocument{%
    \renewcommand{\normalsize}{\fontsize{10}{12}\selectfont}%
    \renewcommand{\small}{\fontsize{9}{11}\selectfont}%
    \renewcommand{\footnotesize}{\fontsize{8}{10}\selectfont}%
  }
\fi

\ifmdoc@thesis
  \geometry{
    a4paper,
    inner     = 40mm,  % Extra binding margin (institutional requirement)
    outer     = 25mm,
    top       = 30mm,
    bottom    = 35mm,
    headheight   = 18pt,  % Increased for thesis line spacing + scrlayer-scrpage
    headsep      = 20pt,
    footskip     = 25pt,
    marginparsep = 5mm,
    marginparwidth = 15mm,
  }
  \linespread{1.25}  % 1.5-spaced for thesis (use 1.5 for double-spaced draft)
\fi

\ifmdoc@book
  \geometry{
    a4paper,
    inner     = 35mm,  % More for binding
    outer     = 20mm,  % Less on outer edge
    top       = 25mm,
    bottom    = 30mm,
    headheight   = 15pt,  % Increased for scrlayer-scrpage compatibility
    headsep      = 20pt,
    footskip     = 25pt,
    marginparsep    = 7mm,
    marginparwidth  = 15mm,
  }
  \linespread{1.10}
\fi

\ifmdoc@report
  \geometry{
    a4paper,
    left      = 25mm,
    right     = 25mm,
    top       = 30mm,
    bottom    = 30mm,
    headheight   = 15pt,  % Increased for scrlayer-scrpage compatibility
    headsep      = 18pt,
    footskip     = 22pt,
    marginparsep = 5mm,
    marginparwidth = 18mm,
  }
  \linespread{1.10}
\fi

\ifmdoc@letter
  \geometry{
    a4paper,
    left      = 25mm,
    right     = 25mm,
    top       = 25mm,
    bottom    = 25mm,
  }
  \linespread{1.05}
\fi

% Default geometry if no option specified
\@ifundefined{Gm@lmargin}{
  \geometry{
    a4paper,
    left      = 25mm,
    right     = 25mm,
    top       = 30mm,
    bottom    = 30mm,
  }
  \linespread{1.08}
}{}

% =============================================================================
% PARAGRAPH FORMATTING
% =============================================================================
\setlength{\parindent}{1em}
\setlength{\parskip}{0pt}

% =============================================================================
% COLORS
% =============================================================================
\RequirePackage{xcolor}

% Brand colors
\definecolor{mdocprimary}{RGB}{0, 95, 178}     % Deep blue
\definecolor{mdocsecondary}{RGB}{99, 102, 106} % Neutral gray
\definecolor{mdocaccent}{RGB}{204, 0, 0}       % Alert red
\definecolor{mdoclink}{RGB}{0, 51, 102}        % Link blue

% Code colors
\definecolor{codebg}{RGB}{248, 248, 248}
\definecolor{codeframe}{RGB}{200, 200, 200}
\definecolor{codekeyword}{RGB}{0, 119, 170}
\definecolor{codestring}{RGB}{163, 21, 21}
\definecolor{codecomment}{RGB}{106, 153, 85}

% Quote colors
\definecolor{quotebg}{RGB}{245, 245, 245}
\definecolor{quotebar}{RGB}{180, 180, 180}

% =============================================================================
% HYPERREF CONFIGURATION
% =============================================================================
\ifmdoc@hyperlinks
  \RequirePackage{hyperref}

  % Base hyperref configuration
  % Note: bookmarksdepth is now handled by bookmark package
  % Note: breaklinks=true is now the default in modern hyperref
  \hypersetup{%
    pdfcreator={LuaLaTeX with moderndoc},%
    pdfproducer={LuaLaTeX},%
    bookmarksnumbered=true,%
    bookmarksopen=true,%
    pdfstartview={FitH},%
    pdfpagemode={UseOutlines},%
    linktocpage=false,%
    pdfnewwindow=true,%
    pdfdisplaydoctitle=true,%
    plainpages=false,%      % Avoid duplicate page destination warnings
    pdfpagelabels=true%     % Use page labels for unique destinations
  }

  % Configure bookmark depth via bookmark package
  \AtBeginDocument{%
    \bookmarksetup{depth=3}%
  }

  % Print mode: no colored links
  \ifmdoc@print
    \hypersetup{colorlinks=false,hidelinks}
  \else
    % Screen mode: colored links
    \hypersetup{%
      colorlinks=true,%
      linkcolor=mdoclink,%
      citecolor=mdoclink,%
      urlcolor=mdocprimary,%
      filecolor=mdocprimary,%
      menucolor=mdoclink,%
      runcolor=mdocprimary%
    }
  \fi

  % Book layout for twoside documents
  \ifmdoc@book
    \hypersetup{pdfpagelayout = {TwoPageRight}}
  \fi
  \ifmdoc@thesis
    \hypersetup{pdfpagelayout = {TwoPageRight}}
  \fi

  \RequirePackage{bookmark}
\fi

% =============================================================================
% HEADING STYLES (using KOMA-Script native commands)
% =============================================================================
% Configure section fonts using KOMA-Script's \setkomafont
% This avoids conflicts with titlesec
% Note: These commands are only available in scrartcl, scrbook, scrreprt
% The scrlttr2 letter class does not have sectioning commands

\ifmdoc@letter\else
  % All dispositions (sectioning commands) use the heading font
  \setkomafont{disposition}{\headingfont\bfseries}

  % Section: Large bold
  \setkomafont{section}{\headingfont\Large\bfseries}
  \RedeclareSectionCommand[
    beforeskip = 2.5ex plus 1ex minus .2ex,
    afterskip  = 1.5ex plus .2ex,
    indent     = 0pt,
  ]{section}

  % Subsection: large bold
  \setkomafont{subsection}{\headingfont\large\bfseries}
  \RedeclareSectionCommand[
    beforeskip = 2ex plus 1ex minus .2ex,
    afterskip  = 1ex plus .2ex,
    indent     = 0pt,
  ]{subsection}

  % Subsubsection: normalsize bold
  \setkomafont{subsubsection}{\headingfont\normalsize\bfseries}
  \RedeclareSectionCommand[
    beforeskip = 1.5ex plus .5ex minus .2ex,
    afterskip  = 0.8ex plus .2ex,
    indent     = 0pt,
  ]{subsubsection}

  % Paragraph: run-in, normalsize bold
  \setkomafont{paragraph}{\headingfont\normalsize\bfseries}
  \RedeclareSectionCommand[
    beforeskip = 1ex plus .5ex minus .2ex,
    afterskip  = 1em,
    indent     = 0pt,
    runin      = true,
  ]{paragraph}

  % Subparagraph: run-in, normalsize italic
  \setkomafont{subparagraph}{\headingfont\normalsize\itshape}
  \RedeclareSectionCommand[
    beforeskip = 0.5ex plus .2ex minus .1ex,
    afterskip  = 1em,
    indent     = \parindent,
    runin      = true,
  ]{subparagraph}
\fi

% =============================================================================
% HEADER AND FOOTER (per document type)
% =============================================================================
% Using scrlayer-scrpage for KOMA-Script compatibility
\RequirePackage[automark, headsepline]{scrlayer-scrpage}

% Short title and author commands for headers (plain text versions)
\newcommand{\shorttitle}[1]{\gdef\mdoc@shorttitle{#1}}
\newcommand{\shortauthor}[1]{\gdef\mdoc@shortauthor{#1}}
\gdef\mdoc@shorttitle{}
\gdef\mdoc@shortauthor{}

% Configure default head/foot widths and separator
\KOMAoptions{
  headsepline=0.4pt,
  footsepline=false,
}
\setkomafont{pagehead}{\small\normalfont}
\setkomafont{pagefoot}{\small\normalfont}

% --- Book headers/footers ---
\defpagestyle{mdocbook}{%
  % head: (width, left, center, right)
  {\textsc{\leftmark}}{}{\textit{\rightmark}}%
}{%
  % foot
  {\thepage}{}{\thepage}%
}

% --- Article headers/footers ---
% Note: Use \shorttitle{} and \shortauthor{} to set header content
\defpagestyle{mdocarticle}{%
  {\textit{\mdoc@shortauthor}}{}{\textit{\mdoc@shorttitle}}%
}{%
  {}{\thepage}{}%
}

% --- Paper headers/footers (minimal) ---
\defpagestyle{mdocpaper}{%
  {}{}{}%
}{%
  {}{\thepage}{}%
}
\KOMAoptions{headsepline=false}%

% --- Thesis headers/footers ---
\defpagestyle{mdocthesis}{%
  {\textit{\rightmark}}{}{\textsc{\leftmark}}%
}{%
  {\thepage}{}{\thepage}%
}

% --- Front matter style (for thesis/book) ---
\defpagestyle{frontmatter}{%
  {}{}{}%
}{%
  {}{\thepage}{}%
}

% --- Report headers/footers ---
\defpagestyle{mdocreport}{%
  {\textit{\leftmark}}{}{\thepage}%
}{%
  {}{}{}%
}

% --- Part pages (no header/footer) ---
\defpagestyle{part}{%
  {}{}{}%
}{%
  {}{}{}%
}

% --- Legacy moderndoc style (backward compatibility) ---
\defpagestyle{moderndoc}{%
  {\textit{\leftmark}}{}{\thepage}%
}{%
  {}{}{}%
}

% Redefine plain style for chapter openings
\renewpagestyle{plain}{%
  {}{}{}%
}{%
  {}{\thepage}{}%
}

% Apply appropriate page style based on document type
\ifmdoc@book
  \KOMAoptions{headsepline=0.4pt}
  \pagestyle{mdocbook}
\else\ifmdoc@thesis
  \KOMAoptions{headsepline=0.4pt}
  \pagestyle{mdocthesis}
\else\ifmdoc@paper
  \KOMAoptions{headsepline=false}
  \pagestyle{mdocpaper}
\else\ifmdoc@article
  \KOMAoptions{headsepline=0.4pt}
  \pagestyle{mdocarticle}
\else\ifmdoc@report
  \KOMAoptions{headsepline=0.4pt}
  \pagestyle{mdocreport}
\else\ifmdoc@letter
  \pagestyle{empty}
\else
  \KOMAoptions{headsepline=0.4pt}
  \pagestyle{moderndoc}
\fi\fi\fi\fi\fi\fi

% =============================================================================
% BIBLIOGRAPHY (biblatex) — Enhanced
% =============================================================================
\ifmdoc@biblatex
  \RequirePackage[%
    backend=biber,%
    sorting=nyt,%
    sortcites=true,%
    style=\mdoc@citestyle,%
    maxnames=3,%
    minnames=1,%
    maxbibnames=99,%
    giveninits=true,%
    uniquename=init,%
    uniquelist=false,%
    doi=true,%
    isbn=false,%
    url=true,%
    eprint=true,%
    urldate=long,%
    hyperref=true,%
    backref=true,%
    date=year,%
    dateabbrev=true,%
    language=autobib,%
    abbreviate=true,%
    block=space%
  ]{biblatex}

  % Back-reference strings
  \DefineBibliographyStrings{english}{
    backrefpage  = {cited on p.\,},
    backrefpages = {cited on pp.\,},
  }

  % Title formatting
  \DeclareFieldFormat{title}{\mkbibemph{#1}}
  \DeclareFieldFormat[article]{title}{#1}
  \DeclareFieldFormat[inproceedings]{title}{#1}

  % DOI formatting
  \DeclareFieldFormat{doi}{%
    \mkbibacro{DOI}\addcolon\space
    \ifhyperref
      {\href{https://doi.org/#1}{\nolinkurl{#1}}}
      {\nolinkurl{#1}}%
  }

  % URL formatting
  \DeclareFieldFormat{url}{%
    \mkbibacro{URL}\addcolon\space
    \url{#1}%
  }

  % ArXiv formatting
  \DeclareFieldFormat{eprint:arxiv}{%
    \mkbibacro{arXiv}\addcolon\space
    \ifhyperref
      {\href{https://arxiv.org/abs/#1}{\texttt{#1}%
        \iffieldundef{eprintclass}{}{\space[\thefield{eprintclass}]}}}%
      {\texttt{#1}%
        \iffieldundef{eprintclass}{}{\space[\thefield{eprintclass}]}}%
  }
\fi

% =============================================================================
% CODE HIGHLIGHTING (minted)
% =============================================================================
\ifmdoc@minted
  \RequirePackage{minted}
  \usemintedstyle{friendly}

  % Default minted settings
  \setminted{
    bgcolor      = codebg,
    frame        = single,
    framesep     = 2mm,
    fontsize     = \small,
    breaklines   = true,
    breakanywhere = false,
    linenos      = false,
    numbersep    = 5pt,
    tabsize      = 2,
  }

  % Inline code
  \newcommand{\code}[1]{\mintinline{text}{#1}}
\fi

% Context-sensitive quotation marks (critical for publications)
% Loaded after minted/fvextra to avoid warning
\RequirePackage[%
  autostyle=true,%
  autopunct=true,%
  english=american,%
  french=guillemets,%
  german=quotes,%
  threshold=2%
]{csquotes}
\SetBlockThreshold{3}

% =============================================================================
% QUOTE/EXTRACT BOXES (tcolorbox) — Enhanced
% =============================================================================
\RequirePackage[most]{tcolorbox}
\tcbuselibrary{breakable, skins}

% Paper quote style (gray background box)
\newtcolorbox{paperquote}[1][]{%
  enhanced,
  breakable,
  colback      = quotebg,
  colframe     = quotebg,
  boxrule      = 0pt,
  left         = 5mm,
  right        = 5mm,
  top          = 3mm,
  bottom       = 3mm,
  arc          = 0mm,
  borderline west = {3pt}{0pt}{quotebar},
  fontupper    = \small\quotefont\itshape,
  before skip  = 1.2em,
  after skip   = 1.2em,
  #1
}

% Block quote with attribution (name only)
\newtcolorbox{attributedquote}[2][]{%
  enhanced,
  breakable,
  colback      = quotebg,
  colframe     = quotebg,
  boxrule      = 0pt,
  left         = 5mm,
  right        = 5mm,
  top          = 3mm,
  bottom       = 3mm,
  arc          = 0mm,
  borderline west = {3pt}{0pt}{quotebar},
  fontupper    = \small\quotefont\itshape,
  before skip  = 1.2em,
  after skip   = 1.2em,
  after upper  = {\par\vspace{0.6em}\hfill\textnormal{--- \textsc{#2}}},
  #1
}

% Cited quote with author and year
\newtcolorbox{citedquote}[3][]{%
  % #1 = optional tcolorbox options
  % #2 = author name
  % #3 = year
  enhanced,
  breakable,
  colback      = quotebg,
  colframe     = quotebg,
  boxrule      = 0pt,
  left         = 5mm,
  right        = 5mm,
  top          = 3mm,
  bottom       = 3mm,
  arc          = 0mm,
  borderline west = {3pt}{0pt}{quotebar},
  fontupper    = \small\quotefont\itshape,
  before skip  = 1.2em,
  after skip   = 1.2em,
  after upper  = {\par\vspace{0.6em}\hfill\textnormal{--- \textsc{#2}, #3}},
  #1
}

% Epigraph for chapter openings
\newenvironment{chapterquote}[2]{%
  % #1 = author, #2 = source/year
  \def\chapterquote@author{#1}%
  \def\chapterquote@source{#2}%
  \begin{flushright}
    \begin{minipage}{0.7\textwidth}
      \small\quotefont\itshape
}{%
      \par\vspace{0.4em}
      \normalfont\small --- \chapterquote@author\ifx\chapterquote@source\empty\else, \textit{\chapterquote@source}\fi
    \end{minipage}
  \end{flushright}
  \vspace{1.5em}
}

% Pull quote for margin emphasis
\newcommand{\pullquote}[1]{%
  \marginnote{%
    \begin{minipage}{\marginparwidth}
      \small\quotefont\itshape
      \enquote{#1}
    \end{minipage}
  }%
}

% Note box
\newtcolorbox{notebox}[1][Note]{%
  enhanced,
  breakable,
  colback      = blue!5,
  colframe     = mdocprimary,
  boxrule      = 1pt,
  left         = 3mm,
  right        = 3mm,
  top          = 2mm,
  bottom       = 2mm,
  arc          = 2mm,
  title        = {\textbf{#1}},
  fonttitle    = \headingfont\small,
  coltitle     = white,
  colbacktitle = mdocprimary,
  before skip  = 1em,
  after skip   = 1em,
}

% Warning box
\newtcolorbox{warningbox}[1][Warning]{%
  enhanced,
  breakable,
  colback      = red!5,
  colframe     = mdocaccent,
  boxrule      = 1pt,
  left         = 3mm,
  right        = 3mm,
  top          = 2mm,
  bottom       = 2mm,
  arc          = 2mm,
  title        = {\textbf{#1}},
  fonttitle    = \headingfont\small,
  coltitle     = white,
  colbacktitle = mdocaccent,
  before skip  = 1em,
  after skip   = 1em,
}

% =============================================================================
% MODERN TABLES (tabularray)
% =============================================================================
\RequirePackage{tabularray}
\UseTblrLibrary{booktabs, varwidth}

% Default table style
\NewTblrTheme{moderndoc}{
  \SetTblrStyle{firsthead}{font=\bfseries\sffamily\small}
  \SetTblrStyle{head}{font=\bfseries\sffamily\small}
}

% Simple table environment
\NewTblrEnviron{mdtable}
\SetTblrOuter[mdtable]{long}
\SetTblrInner[mdtable]{
  rowsep   = 2pt,
  colsep   = 6pt,
  hlines   = {0.5pt, gray!50},
  vlines   = {},
  row{1}   = {font=\bfseries\sffamily, bg=gray!10},
}

% =============================================================================
% FIGURES AND CAPTIONS — Enhanced
% =============================================================================
\RequirePackage{graphicx}
\RequirePackage{caption}
\RequirePackage{subcaption}

\captionsetup{
  font           = small,
  labelfont      = {bf, sf},
  textfont       = {},
  format         = hang,
  indention      = 0pt,
  justification  = justified,
  singlelinecheck = true,
  skip           = 8pt,
  position       = auto,
}

% Table caption at top
\captionsetup[table]{position=above, skip=5pt}

% Figure caption at bottom
\captionsetup[figure]{position=below}

% Subcaption styling
\captionsetup[sub]{
  font      = footnotesize,
  labelfont = bf,
}

% =============================================================================
% PER-CHAPTER NUMBERING (for book/thesis)
% =============================================================================
\ifmdoc@book
  \@ifundefined{chapter}{}{%
    \counterwithin{figure}{chapter}
    \counterwithin{table}{chapter}
    \counterwithin{equation}{chapter}
  }
\fi

\ifmdoc@thesis
  \@ifundefined{chapter}{}{%
    \counterwithin{figure}{chapter}
    \counterwithin{table}{chapter}
    \counterwithin{equation}{chapter}
  }
\fi

% =============================================================================
% APPENDIX HANDLING — Enhanced (not for letters)
% =============================================================================
\ifmdoc@letter\else
  % Appendix configuration
  \renewcommand{\appendixname}{Appendix}
  \renewcommand{\appendixtocname}{Appendices}
  \renewcommand{\appendixpagename}{Appendices}

  % Start appendices command
  \newcommand{\startappendices}{%
    \appendix
    \ifmdoc@book
      \renewcommand{\thefigure}{\Alph{chapter}.\arabic{figure}}
      \renewcommand{\thetable}{\Alph{chapter}.\arabic{table}}
    \fi
    \ifmdoc@thesis
      \renewcommand{\thefigure}{\Alph{chapter}.\arabic{figure}}
      \renewcommand{\thetable}{\Alph{chapter}.\arabic{table}}
    \fi
  }
\fi

% =============================================================================
% MATH SUPPORT
% =============================================================================
\RequirePackage{amsmath}
% Suppress mathtools compatibility warnings (we accept unicode-math's behavior)
\RequirePackage[warnings-off={mathtools-overbracket,mathtools-colon}]{unicode-math}

% Set math font (STIX Two matches well with text fonts)
\IfFontExistsTF{STIX Two Math}{
  \setmathfont{STIX Two Math}
}{
  \IfFontExistsTF{Latin Modern Math}{
    \setmathfont{Latin Modern Math}
  }{}
}

% Mathematical enhancements
\DeclareMathOperator*{\argmax}{arg\,max}
\DeclareMathOperator*{\argmin}{arg\,min}
\newcommand{\abs}[1]{\left\lvert#1\right\rvert}
\newcommand{\norm}[1]{\left\lVert#1\right\rVert}
\newcommand{\set}[1]{\left\{#1\right\}}

% =============================================================================
% CROSS-REFERENCING
% =============================================================================
\RequirePackage[capitalize, nameinlink]{cleveref}

% =============================================================================
% ABSTRACT STYLING (per document type) — Enhanced
% =============================================================================
\ifmdoc@article
  \RequirePackage{abstract}
  \renewcommand{\abstractnamefont}{\headingfont\bfseries\normalsize}
  \renewcommand{\abstracttextfont}{\small}
  \setlength{\absleftindent}{0pt}
  \setlength{\absrightindent}{0pt}
  \setlength{\abstitleskip}{-\parindent}

  % Keywords environment
  \newenvironment{keywords}{%
    \vspace{0.5em}%
    \noindent\textbf{Keywords:}\space
  }{\par}
\fi

\ifmdoc@paper
  \RequirePackage{abstract}
  \renewcommand{\abstractnamefont}{\headingfont\bfseries\normalsize}
  \renewcommand{\abstracttextfont}{\small}
  \setlength{\absleftindent}{0pt}
  \setlength{\absrightindent}{0pt}
  \setlength{\abstitleskip}{-\parindent}

  % Keywords environment
  \newenvironment{keywords}{%
    \vspace{0.5em}%
    \noindent\textbf{Keywords:}\space
  }{\par}

  % ACM-style CCS classification
  \newenvironment{ccsclassification}{%
    \vspace{0.3em}%
    \noindent\textbf{CCS Concepts:}\space\small
  }{\par}
\fi

% Thesis abstract (full page)
\ifmdoc@thesis
  \newenvironment{thesisabstract}{%
    \cleardoublepage
    \chapter*{Abstract}
    \addcontentsline{toc}{chapter}{Abstract}
    \thispagestyle{plain}
  }{}

  % Second abstract in another language
  \newenvironment{abstractfr}[1][R\'{e}sum\'{e}]{%
    \cleardoublepage
    \selectlanguage{french}
    \chapter*{#1}
    \addcontentsline{toc}{chapter}{#1}
    \thispagestyle{plain}
  }{%
    \selectlanguage{english}
  }
\fi

% Book abstract (preface-style)
\ifmdoc@book
  \newenvironment{bookabstract}{%
    \cleardoublepage
    \thispagestyle{empty}
    \vspace*{2cm}
    \begin{center}
      {\headingfont\Large\bfseries Abstract}
    \end{center}
    \vspace{1cm}
    \begin{quotation}
  }{%
    \end{quotation}
    \clearpage
  }
\fi

% Graphical abstract support (for journals)
\newcommand{\graphicalabstract}[1]{%
  \begin{figure}[t]
    \centering
    \includegraphics[width=\textwidth]{#1}
    \caption*{\textbf{Graphical Abstract}}
  \end{figure}
}

% =============================================================================
% LIST STYLING
% =============================================================================
\RequirePackage{enumitem}
\setlist{
  topsep      = 0.5em,
  itemsep     = 0.25em,
  parsep      = 0pt,
  leftmargin  = 1.5em,
}

% =============================================================================
% SEMANTIC MARKUP COMMANDS
% =============================================================================
% Japanese term with reading
\newcommand{\jpterm}[2]{\textit{#1} ({#2})}

% Japanese text
\newcommand{\jp}[1]{{#1}}

% Concept/key term
\newcommand{\concept}[1]{\textbf{#1}}

% Manual citation (for footnotes)
\newcommand{\manualcite}[1]{\textsuperscript{[#1]}}

% TODO marker
\newcommand{\todo}[1]{\textcolor{mdocaccent}{\textbf{[TODO: #1]}}}

% Foreign terms
\newcommand{\foreign}[1]{\textit{#1}}

% Term with index entry
\ifmdoc@makeindex
  \newcommand{\term}[1]{\textit{#1}\index{#1}}
  \newcommand{\termbf}[1]{\textit{#1}\index{#1|textbf}}
\else
  \newcommand{\term}[1]{\textit{#1}}
  \newcommand{\termbf}[1]{\textit{#1}}
\fi

% Acronyms (small caps)
\newcommand{\acronym}[1]{\textsc{\MakeLowercase{#1}}}

% Book titles (use \bookref to avoid conflict with book template's \booktitle)
\newcommand{\bookref}[1]{\textit{#1}}

% Software names
\newcommand{\software}[1]{\textsf{#1}}

% Email addresses
\newcommand{\email}[1]{\href{mailto:#1}{\texttt{#1}}}

% Quick inline quote using csquotes
\newcommand{\q}[1]{\enquote{#1}}
\newcommand{\qq}[1]{\enquote*{#1}}

% =============================================================================
% INDEX COMMANDS (conditional)
% =============================================================================
\ifmdoc@makeindex
  \newcommand{\idx}[1]{#1\index{#1}}
  \newcommand{\idxbf}[1]{#1\index{#1|textbf}}
\fi

% =============================================================================
% END OF PACKAGE
% =============================================================================
\endinput
